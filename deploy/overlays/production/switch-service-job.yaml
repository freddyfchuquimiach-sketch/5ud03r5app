apiVersion: batch/v1
kind: Job
metadata:
  name: switch-service-to-green
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: switch-service
        image: bitnami/kubectl:latest
        command:
        - /bin/sh
        - -c
        - |
          CURRENT=$(kubectl get svc app-service -o jsonpath='{.spec.selector.version}')
          if [ "$CURRENT" = "blue" ]; then
            kubectl patch svc app-service -p '{"spec":{"selector":{"version":"green"}}}'
          else
            echo "Service already pointing to green"
          fi
